```{r}
library(RSQLite)
con <- DBI::dbConnect(SQLite(), "BankChurn.db")
con1 = DBI::dbConnect(SQLite(), "EmployeeChurn.db")
```
```{r}
library(dplyr)
churn = dbGetQuery(con, "SELECT * FROM churn")
churn = churn %>% dplyr::select(-CustomerId, -Surname)
cities = dbGetQuery(con1, "SELECT * FROM cities")
departments = dbGetQuery(con1, "SELECT * FROM departments")
info = dbGetQuery(con1, "SELECT * FROM info")
```

```{r}
ggplot(churn %>% filter(CountryId=="jd73"))+ geom_bar(aes(x = Exited))
churn %>% filter(CountryId=="jd73") %>% nrow()
```
```{r}
for (var in names(churn)[c(2,3,5,7,8,9,11)]){
  churn[[var]] = as.factor(churn[[var]])
}
library(partykit)
library(caret)
set.seed(1)
ind = createDataPartition(churn$Exited, p = 0.8, list = F)
train = churn[ind,]
test = churn[-ind,]

churn1 = churn
churn1$Balance = log(churn1$Balance+1)
churn1$EstimatedSalary = log(churn1$EstimatedSalary)


set.seed(1)
ind = createDataPartition(churn1$Exited, p = 0.8, list = F)
train1 = churn1[ind,]
test1 = churn1[-ind,]

```


### Model 1: ctree
```{r}
tree_model = ctree(Exited~., data = train)
tree_model1 = ctree(Exited~., data = train1)

```

### Model 2: Logit
```{r}
logit_model = train(Exited~., data = train, method = "glm", family = binomial(link = "logit"))
logit_model1 = train(Exited~., data = train1, method = "glm", family = binomial(link = "logit"))
```
### Model 3: Linear

```{r}
linear_model = lm(Exited~., data = train)
linear_model1 = lm(Exited~., data = train1)

```

### Model 4: randomForest
```{r}

library(randomForest)
set.seed(1)
rf_model= randomForest(Exited~.,data=train, mtry=5, importance=TRUE)
rf_model1= randomForest(Exited~.,data=train1, mtry=5, importance=TRUE)

```

### Model 5: Gradient boosting
```{r}
library(gbm)
set.seed(1)
boost_model = caret::train(Exited~., data=train, method = "gbm", verbose = F) 
boost_model1 = caret::train(Exited~., data=train1, method = "gbm", verbose = F) 

```

```{r}
get_acc = function(model, test){
  test$pred = predict(model, newdata = test)
  if(is.integer(test$pred)|is.factor(test$pred)){
    a = confusionMatrix(test$pred, test$Exited)
    return(a$overall["Accuracy"])
  }else{
    source("F:/Github/Mainor_2/1_seminars/11_13_lab09_rating+gini/compute_gini.R")
    gini = gini_find_split(data = test, real = Exited, variable = pred)
    test$pred1 = ifelse(test$pred>gini, 1, 0)
    test$pred1 = as.factor(test$pred1)
    b = confusionMatrix(test$pred1, test$Exited)
    return(b$overall["Accuracy"])
  }
}
```

```{r}
get_acc(tree_model, test)
get_acc(tree_model1, test1)
get_acc(logit_model, test)
get_acc(logit_model1, test1)
get_acc(linear_model, test)
get_acc(linear_model1, test1)
get_acc(rf_model, test)
get_acc(rf_model1, test1)
get_acc(boost_model, test)
get_acc(boost_model1, test1)
```

